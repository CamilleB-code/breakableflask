name: Automatisation des tests DevSecOps
on: push
jobs:
  Dependances:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout du Code
        uses: actions/checkout@v4
     
      - name: Contrôle des dépendances avec Trivy
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: 'requirements.txt'   # ← mieux que 'input' selon la doc récente
          severity: 'CRITICAL,HIGH,MEDIUM,LOW'   # ← j'ai ajouté LOW pour être exhaustif
          format: 'table'
          output: 'trivy-deps-table.txt'         # ← on sauve la sortie table
          # Optionnel : aussi en JSON pour parsing futur
          # format: 'json'
          # output: 'trivy-deps.json'

      - name: Sauvegarde sortie JSON (optionnel mais recommandé)
        run: |
          trivy fs --format json --output trivy-deps.json requirements.txt || true

      - name: Upload artifact - scan dépendances
        if: always()   # upload même en cas d'erreur
        uses: actions/upload-artifact@v4
        with:
          name: trivy-dependances
          path: |
            trivy-deps*
          retention-days: 14

      - name: Résultat
        if: success()
        run: echo "Scan réussi. Aucune vulnérabilité détectée."
      - name: Résultat
        run: |
          echo "Scan terminé, rapport disponible."
  
  Dockerfile:
    runs-on: ubuntu-latest
    needs: Dependances
    steps:

      - name: Checkout du Code
        uses: actions/checkout@v4

      - name: Construire l'Image
        run: |
          echo "Construction de l'image Docker pour analyse..."
          docker build -t img:latest .
          
      - name: Scanner l'Image avec Trivy
        run: |
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sudo sh -s -- -b /usr/local/bin
          
          echo "Scann image img:latest pour les vulnérabilités..."
          trivy image --severity CRITICAL,HIGH,MEDIUM,LOW img:latest

      - name: Résultat du Scan de l'Image
        run: echo "Scan de l'image terminé, rapport disponible."


  Deploy:
    runs-on: ubuntu-latest
    needs: Dockerfile
    steps:
      - name: Deploy
        run: |
          echo "Rien à faire ici. Votre application est prête à être déployée"
