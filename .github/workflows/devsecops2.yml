name: Automatisation des tests DevSecOps
on: push
jobs:
  Dependances:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Dependances
        run: |
          if [ ! -f "requirements.txt" ]; then
            echo "le fichier requirements.txt n'existe pas"
            exit 1
          fi
          echo "Le fichier requirements.txt existe"

  Dockerfile:
    runs-on: ubuntu-latest
    needs: Dependances
    steps:
      - uses: actions/checkout@v4
      - name: Créer et tester Dockerfile
        run: |
          # Créer un Dockerfile minimal
          cat > Dockerfile <<EOF
FROM python:3.10

WORKDIR /app

COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

COPY . .

CMD ["python", "app.py"]
EOF

          if [ ! -f "Dockerfile" ]; then
            echo "le fichier Dockerfile n'existe pas"
            exit 1
          fi
          echo "Le fichier Dockerfile existe"
          
          if ! grep -q "^FROM" Dockerfile; then
            echo "Dockerfile invalide (pas d'instruction FROM)"
            exit 1
          fi
          echo "Dockerfile valide"

  Deploy:
    runs-on: ubuntu-latest
    needs: Dockerfile
    steps:
      - name: Deploy
        run: |
          echo "Rien à faire ici. Votre application est prête à être déployée"
